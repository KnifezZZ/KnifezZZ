---
title: CMS系统搭建思路和技术选型

description: 'cms系统搭建的技术选型准则和思路'

date: 2019-12-14 09:05:10

tags:

  - 程序设计

  - CMS
---

## 技术选型准则

1. 需求优先，一切技术选型以满足项目需求为主
2. 在需求满足的情况下，选择自己/团队最擅长最通用的技术，即降低学习成本，提高开发进度。
3. 以上两点满足时，优先考虑大公司的方案，

    1) 技术使用广泛
    2) 有专人维护，经得起考验（阿里系除外）

## 需求分析

本文搭建思路和技术选型源于2019年中旬对后台的整合升级，升级的需求如下

- 原有静态模板方法调用数据的逻辑在后台编写，适应性通用性不强，不能很好地兼容各个网站的模板。

- 服务器存在由编辑器漏洞等因素产生被攻击挂马的案例。线上尽量只保留必要接口，不使用第三方组件，减少被攻击的几率。

- 原有代码多个项目复用后代码难以统一，bug修复需多处重复修改验证。

- 界面操作复杂。

- 富文本编辑器操作不便，不能直接转换为markdown格式内容。

## 程序设计

### 整体架构

考虑上述需求之后，项目整体分为三部分

  1. **展示层**， 负责与用户交互，提交表单，修改内容等操作。
      - 功能点
        1. 用户交互
        2. 组件开发
        3. echarts数据可视化
        4. 菜单路由鉴权
      - 目的
        1. 解决展示层操作繁琐，体验差问题
        2. 
  2. **服务层**， 基础功能支持和处理用户提交的数据和操作，并向子站点发送生成请求。
      - 功能点
        1. 权限系统
        2. 站点数据隔离
        3. 第三方数据同步处理
        4. 日志记录
        5. 
      - 目的
        1. 数据库迁移后适配所有站点，统计分析，细节优化等更新一次覆盖所有站点。
        2. 

  3. **子站点接收端**，开发完之后基本不做修改，只用于接收生成静态页请求和同步数据
      - 功能点 
        1. 静态页生成逻辑
        2. 数据同步接口
        3. api接口调用动态密钥认证。
        4. 调用日志记录
      - 目的
        1. 减少发布次数，解除后台功能升级与线上站点的耦合。
        2. 降低被攻击的漏洞

### 展示层技术选型

|                  |          LayUI           |       iView        |  ant Design  | BootStrap  |           easyUi            | ligerUi |
|------------------|:------------------------:|:------------------:|:------------:|:----------:|:---------------------------:|--------:|
| 功能点           |            中            |         高         |      高      |     中     |             中              |      低 |
| 开发难度         | 低，少量html,css,js知识  |   中，需学习vue    | 中,需学习vue |     低     | 中,自定义配置，拓展方法较多 |      中 |
| 社区活跃度       | 高，专门自建社区，拓展库 | 中，自建社区不活跃 |      --      |     --     |             --              |      -- |
| 文档支持         |            高            |         高         |      高      |     高     |             高              |      中 |
| 个人掌握         |            高            |         中         |      低      |     中     |             中              |      低 |
| 开发便捷度       |            中            |         高         |      高      |     中     |             中              |      低 |
| 美观度           |            中            |         高         |      高      |     中     |        低，需调主题         |      低 |
| 普及度           |        18,000,000        |     27,200,000     |  6,320,000   | 28,400,000 |         16,000,000          |  459000 |
| 最近一次更新时间 |        2019-09-10        |     2019-10-22     |  2019-12-10  | 2016-07-25 |         2018-12-25          |    2016 |

最终结合实际尝试效果，放弃了`ant design`，`easyUI`和`ligerUi`由于项目维护，美观度和个人喜好原因排除在外，`bootstrap`功能不足以满足项目需求。

在Layui和iView的选择中layui在最近两年一直是个人搭建站点的主要选择，但是实际体验中由于各项功能不太完善，自定义设置较差，很多功能需要借助第三方库来实现，为此我还专门拓展了layedit编辑器来达到使用需求。

iView（现已更名为 View UI）有官方的admin管理后台的脚手架，可拿来即用，文档支持和普及度（百度搜索结果数）比较高，体验过vue开发后觉得可以尝试，便在新版程序中采用改框架作为展示层。

#### 选用iView原因
  1. 功能丰富
  2. 文档支持高
  3. 组件式开发方便功能复用
  4. 更新维护较好


### 服务端搭建
#### 使用的组件和技术
- 基础框架采用 `.net webapi`
> 方便前后台交互

- 选用数据库 `SqlServer` ORM框架`Dapper`
> 速度快，可写复杂sql
- Nsoup 解析html页面，处理复杂逻辑
- NPOI 操作office文件，实现excel的导入导出功能
- SSE长链接进行服务器推送，实现消息实时提醒
> 耗时功能后台进程处理，不影响前台操作

#### 权限管理-区分不同站点账户和数据

权限主要由用户（OA_User） 站点（WebSite) 角色（RM_Role）和 角色分配表（RM_Permission）构成。

用户
- 通过` OA_User.FK_Domain => WebSite.Domain `关联自己负责的站点
- 通过` OA_User.FK_Role => RM_Role => RM_Permission`来分配菜单和操作权限

RM_Permission保存角色设置的权限

WebSite分配设置站点的各项参数，如上传文件夹地址，生成地址，url生成规则等等。

产品新闻等数据全部关联FK_Domain来确定哪些用户展示哪些数据。

### 站点api接口

- 基础框架采用 `.net webapi`
- 生成静态页采用 `Razor Engine`，可在Razor页面编写C#代码，调用后台方法。
![RazorEngine示例](https://blog-1300352674.cos.ap-shanghai.myqcloud.com/undefined20191214142600.png)
- 数据库使用`Sqlite`, ORM框架采用`Dapper`
>sqlite减少服务器资源压力，方便快捷

## 优化思路

技术栈确定之后，要考虑的便是如何提升用户的操作体验。个人总结出如下几点
 - 常用功能首页直接可见
 - 可以合并的操作一次完成
 - 能省略的点击操作步骤尽量省略（三步点击原则）

### 新增/修改新闻流程
 1. 编辑数据
 2. 提交后台
 3. 返回列表选择当前新闻,上一篇下一篇新闻，=> 点击生成
 4. 找到首页和新闻列表生成按钮
 5. 勾选pc,移动 =>点击生成
 
 修改后的逻辑
 1. 编辑数据
 2. 提交后台
 3. 后台保存完数据之后，自动同步至线上站点，然后触发生成操作，将首页，列表页，上一篇下一篇一并生成。=> SSE返回前台生成结果消息。
>提交后台之后无需等待，可进行其他操作。由原来的繁琐流程减为一次提交操作。

### 内容列表

下拉面板直接展示该页面的数据，方便优化快速查看当前页面的关键词排名情况，PV情况和历史修改记录。

![20191214144600.png](https://blog-1300352674.cos.ap-shanghai.myqcloud.com//undefined20191214144600.png)

### 编辑页面

新增页面修改助手,随时查看页面的百度搜索词数据，5118关键词排名数据，为页面修改提供方向和数据支撑。
![页面修改助手](https://blog-1300352674.cos.ap-shanghai.myqcloud.com/undefined20191214144936.png)

### 监控台

监控服务器异常访问记录，文件修改时间记录,即时发现镜像抄袭异常。
![异常访问和文件修改时间监控](https://blog-1300352674.cos.ap-shanghai.myqcloud.com/undefined20191214143804.png)





